{% extends 'default_layout.html' %}

{% block extraCSS %}
<style>
  #GraficosTablas{
    display: none; /* Se oculta por defecto y se muestra con JS */
  }
</style>
{% endblock %}

{% block page_title %}
    <div class="col-sm-6">
        <h1 class="m-0">Dashboard</h1>
    </div>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="#">Inicio</a></li>
    <li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block contenidos %}
    <div class="container">
        {# Sección para el Dashboard de Docentes (Perfil 06) #}
        {% if codigo_perfil == '06' %}
            <div class="row">
                <div class="col-12">
                    <h3 class="mb-3">Indicadores Educativos - Mis Grados</h3>
                    <p>Bienvenido/a, <strong id="teacherName">{{ nombre_personal }}</strong></p>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="selectAnnLectivo">Año Lectivo:</label>
                    <select id="selectAnnLectivo" class="form-control select2" style="width: 100%;">
                        <option value="">Seleccione un Año</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="selectGradoSeccionTurno">Grado / Sección / Turno:</label>
                    <select id="selectGradoSeccionTurno" class="form-control select2" style="width: 100%;" disabled>
                        <option value="">Seleccione Grado / Sección / Turno</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="btnLoadIndicators" class="btn btn-primary btn-block"><i class="fas fa-chart-line"></i> Cargar Indicadores</button>
                </div>
            </div>

            <div class="row">
                {# Cards de Indicadores para Docentes #}
                <div class="col-lg-3 col-6"><div class="small-box bg-info"><div class="inner"><h3 id="totalStudents">0</h3><p>Total de Estudiantes a Cargo</p></div><div class="icon"><i class="ion ion-person-add"></i></div><a href="#" class="small-box-footer">Más info <i class="fas fa-arrow-circle-right"></i></a></div></div>
                <div class="col-lg-3 col-6"><div class="small-box bg-success"><div class="inner"><h3 id="assignedGrades">0</h3><p>Grados/Secciones Asignadas</p></div><div class="icon"><i class="ion ion-stats-bars"></i></div><a href="#" class="small-box-footer">Más info <i class="fas fa-arrow-circle-right"></i></a></div></div>
                <div class="col-lg-3 col-6"><div class="small-box bg-warning"><div class="inner"><h3 id="approvalRate">0<sup style="font-size: 20px">%</sup></h3><p>Tasa de Aprobación General</p></div><div class="icon"><i class="ion ion-pie-graph"></i></div><a href="#" class="small-box-footer">Más info <i class="fas fa-arrow-circle-right"></i></a></div></div>
                <div class="col-lg-3 col-6"><div class="small-box bg-danger"><div class="inner"><h3 id="lowPerformanceStudents">0</h3><p>Estudiantes con Bajo Rendimiento</p></div><div class="icon"><i class="ion ion-alert-circled"></i></div><a href="#" class="small-box-footer">Más info <i class="fas fa-arrow-circle-right"></i></a></div></div>
            </div>
{# Fila para Gráficos y Tablas Detalladas para Docentes (Diseño 2x1) #}
            <div class="row">
                <section class="col-lg-6 connectedSortable">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar mr-1"></i>
                                Rendimiento por Asignatura
                            </h3>
                        </div>
                        <div class="card-body">
                            <canvas id="performanceChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </section>

                <section class="col-lg-6 connectedSortable">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users mr-1"></i>
                                Distribución de Estudiantes por Grado
                            </h3>
                        </div>
                        <div class="card-body">
                            <canvas id="studentDistributionChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                        </div>
                    </div>
                </section>
            </div>
            <div class="row">
                 <section class="col-lg-12 connectedSortable">
                     <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-th mr-1"></i>
                                Resumen de Mis Grados Asignados
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <ul class="nav nav-pills flex-column" id="gradesList">
                                <li class="nav-item"><a href="#" class="nav-link"><i class="far fa-circle text-secondary"></i> Esperando selección...</a></li>
                            </ul>
                        </div>
                    </div>
                </section>
            </div>

        {% else %}
        {# Contenido para perfiles generales (01, 04, 05, etc.) #}
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="lstannlectivo">Año Lectivo:</label>
                <select id="lstannlectivo" class="form-control select2" style="width: 100%;">
                    <option value="">Seleccione un Año</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="btnLoadGeneralIndicators" class="btn btn-primary btn-block"><i class="fas fa-sync-alt"></i> Actualizar Indicadores</button>
            </div>
        </div>

        <div class="row">
            <!-- Bloque del Small-Box de Estudiantes -->
        <div class="col-12 col-sm-12 col-md-6 col-lg-4 col-xl-3">
            <div class="small-box bg-info">
                <div class="inner">
                    <h6>
                        <span id="totalEstudiantesMasculino">0</span> M /
                        <span id="totalEstudiantesFemenino">0</span> F
                    </h6>
                    <h6><span id="totalEstudiantes">0</span> - Estudiantes</h6>
                    </div>
                <div class="icon">
                    <i class="fas fa-restroom"></i>
                </div>
                <!-- PIE MODIFICADO CON MENÚ DESPLEGABLE -->
                <div class="small-box-footer dropdown">
                    <button class="btn btn-sm btn-block btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Ver Reportes <i class="fas fa-arrow-circle-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" id="linkReporteIndicadores" href="#" target="_blank">Indicadores Educativos</a>
                        <a class="dropdown-item" id="linkReporteMemoria" href="#" target="_blank">Memoria de Labores</a>
                    </div>
                </div>
                <!-- FIN DEL PIE MODIFICADO -->
            </div>
        </div>
            <!-- Small-Box Personal Administrativo con desglose - MODIFICADO -->
            <div class="col-12 col-sm-12 col-md-6 col-lg-4 col-xl-3">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h6><span id="totalAdminMasculino">0</span> M / <span id="totalAdminFemenino">0</span> F</h6>
                        <h6><span id="totalAdminTotal">0</span> - Personal Adm.</h6>
                    </div>
                    <div class="icon"><i class="fas fa-user-tie"></i></div>
                    <a href="php_libs/reportes/Personal/NominaAdministrativos.php" target="_blank" class="small-box-footer">
                        Ver Nómina <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-4 col-xl-3"><div class="small-box bg-warning"><div class="inner"><h3><span id="TotalFamilias">0</span></h3><p>Total de Familias</p></div><div class="icon"><i class="fas fa-users"></i></div><a href="#" class="small-box-footer"> Más Detalles <i class="fas fa-arrow-circle-right"></i></a></div></div>
            <div class="col-12 col-sm-12 col-md-6 col-lg-4 col-xl-3">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h6><span id="totalDocentesMasculino">0</span> M / <span id="totalDocentesFemenino">0</span> F</h6>
                        <h6><span id="totalDocentes">0</span> - Docentes</h6>
                    </div>
                    <div class="icon"><i class="fas fa-chalkboard-teacher"></i></div>
                    <a href="php_libs/reportes/Personal/NominaDocentes.php" target="_blank" class="small-box-footer">
                        Ver Nómina <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>
        
<section id="GraficosTablas">
                    <div class="row">
                        <!-- Gráfico de Género (Doughnut) -->
                        <div class="col-md-6">
                            <div class="jumbotron">
                                <h2>Matrícula por Género</h2>
                                <p>
                                    <button type="button" class="btn btn-primary btn-sm">Masculino <span class="badge badge-light" id="MatriculaMasculino">0</span></button>
                                    <button type="button" class="btn btn-danger btn-sm">Femenino <span class="badge badge-light" id="MatriculaFemenino">0</span></button>
                                    <button type="button" class="btn btn-success btn-sm">Total <span class="badge badge-light" id="MatriculaTotal">0</span></button>
                                </p>
                                <div>
                                    <canvas id="GraficoMatricula" height="250px"></canvas>    
                                </div>
                            </div>
                        </div>

                        <!-- NUEVO: Gráfico de Matrícula por Turno (Barras) -->
                        <div class="col-md-6">
                            <div class="jumbotron">
                                <h2>Matrícula por Turno</h2>
                                <p>Distribución de estudiantes por género en cada turno.</p>
                                <div>
                                    <canvas id="turnoDistributionChart" height="250px"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Tabla de Matrícula -->
                        <div class="col-md-12">
                             <div class="jumbotron">
                                <h2>Detalle de Matrícula por Modalidad</h2>
                                <table class="table table-striped table-sm" id="listadoMatricula">     
                                    <thead>     
                                        <tr>     
                                            <th>N°</th>     
                                            <th>Modalidad</th>     
                                            <th>Turno</th>     
                                            <th>Masculino</th>     
                                            <th>Femenino</th>     
                                            <th>Total</th>     
                                        </tr>                         
                                    </thead>     
                                    <tbody id="listaMatricula"></tbody>     
                                </table>             
                            </div>
                        </div>
                    </div>
                </section>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="js/plugins/chart.js/Chart.min.js"></script>

    <script>
      $(document).ready(function () { 
        $(document).ajaxStop(function () { $('#myModal').modal('hide'); });
        $(document).ajaxError(function () { $('#myModal').modal('hide'); });   
      });
      const Toast = Swal.mixin({
          toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
      });
    </script>

    {% if codigo_perfil == '06' %}
        <script>
            // Lógica para el perfil 06 (Docente) - Esta parte ya funcionaba correctamente
            $(function () {
                let teacherPerformanceChart;
                $('#selectAnnLectivo, #selectGradoSeccionTurno').select2({ placeholder: "Seleccione una opción", allowClear: true });

                function loadAcademicYearsForTeacher() {
                    $.ajax({
                        url: 'php_libs/soporte/dashboard/phpAjaxDashboard.inc.php', type: 'POST', dataType: 'json',
                        data: { action: 'getAcademicYears', codigo_perfil: '{{ codigo_perfil }}' },
                        success: function(response) {
                            const $select = $('#selectAnnLectivo');
                            $select.empty().append('<option value="">Seleccione un Año</option>');
                            if (response.success && response.years.length > 0) {
                                response.years.forEach(function(year) { $select.append(`<option value="${year.codigo}">${year.nombre}</option>`); });
                                $select.val(response.years[0].codigo).trigger('change');
                            } else { Toast.fire({ icon: 'warning', title: response.message || 'No se encontraron años lectivos.' }); }
                        },
                        error: function() { Toast.fire({ icon: 'error', title: 'Error al cargar años lectivos.' }); }
                    });
                }

                function loadTeacherGradesAndSections(annLectivo) {
                    const $select = $('#selectGradoSeccionTurno');
                    $select.empty().append('<option value="">Seleccione Grado / Sección / Turno</option>');
                    if (!annLectivo) { $select.prop('disabled', true); return; }
                    $select.prop('disabled', false);
                    $.ajax({
                        url: 'php_libs/soporte/dashboard/phpAjaxDashboard.inc.php', type: 'POST', dataType: 'json',
                        data: { action: 'getTeacherGradesAndSections', codigo_personal: '{{ codigo_personal }}', codigo_ann_lectivo: annLectivo },
                        success: function(response) {
                            if (response.success && response.grades.length > 0) {
                                response.grades.forEach(function(grade) { $select.append(`<option value="${grade.id_combinado}">${grade.nombre_combinado}</option>`); });
                            } else { Toast.fire({ icon: 'info', title: response.message || 'No tiene grados asignados este año.' }); }
                        },
                        error: function() { Toast.fire({ icon: 'error', title: 'Error al cargar grados/secciones.' }); }
                    });
                }
function loadTeacherDashboardData() {
                    const selectedAnnLectivo = $('#selectAnnLectivo').val();
                    const selectedGradoSeccionTurno = $('#selectGradoSeccionTurno').val();
                    if (!selectedAnnLectivo || !selectedGradoSeccionTurno) {
                        Toast.fire({ icon: 'info', title: 'Por favor, seleccione un Año y un Grado.' });
                        return;
                    }
                    $.ajax({
                        url: 'php_libs/soporte/dashboard/phpAjaxDashboard.inc.php', type: 'POST', dataType: 'json',
                        data: { action: 'getTeacherIndicators', codigo_personal: '{{ codigo_personal }}', codigo_ann_lectivo: selectedAnnLectivo, codigo_grado_seccion_turno: selectedGradoSeccionTurno },
                        success: function(response) {
                            if (response.success) {
                                // --- Carga de Cards (sin cambios) ---
                                $('#totalStudents').text(response.data.total_students || 0);
                                $('#assignedGrades').text(response.data.assigned_grades || 0);
                                $('#approvalRate').html((response.data.approval_rate || 0) + '<sup style="font-size: 20px">%</sup>');
                                $('#lowPerformanceStudents').text(response.data.low_performance_students || 0);

                                // --- Lógica para la lista de grados y el NUEVO gráfico ---
                                const $gradesList = $('#gradesList');
                                $gradesList.empty();
                                if (response.data.grades && response.data.grades.length > 0) {
                                    response.data.grades.forEach(function(grade) {
                                        $gradesList.append(`<li class="nav-item"><a href="#" class="nav-link"><i class="far fa-circle text-info"></i> ${grade.nombre_grado} ${grade.nombre_seccion} <span class="badge bg-primary float-right">${grade.estudiantes_count}</span></a></li>`);
                                    });
                                    
                                    // === LÓGICA PARA EL NUEVO GRÁFICO DE DISTRIBUCIÓN ===
                                    const ctxDist = document.getElementById('studentDistributionChart').getContext('2d');
                                    if (window.studentDistributionChart instanceof Chart) { window.studentDistributionChart.destroy(); }
                                    
                                    const distLabels = response.data.grades.map(g => `${g.nombre_grado} ${g.nombre_seccion}`);
                                    const distData = response.data.grades.map(g => g.estudiantes_count);

                                    window.studentDistributionChart = new Chart(ctxDist, {
                                        type: 'bar',
                                        data: {
                                            labels: distLabels,
                                            datasets: [{
                                                label: 'N° de Estudiantes',
                                                data: distData,
                                                backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)'],
                                                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                                                borderWidth: 1
                                            }]
                                        },
                                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                                    });

                                } else { 
                                    $gradesList.append(`<li class="nav-item"><a href="#" class="nav-link"><i class="far fa-circle text-secondary"></i> No hay datos de grados.</a></li>`);
                                }

                                // --- Lógica para el gráfico de Rendimiento (el que ya existía) ---
                                if (response.data.performance_by_grade && response.data.performance_by_grade.length > 0) {
                                    const ctxPerf = document.getElementById('performanceChart').getContext('2d');
                                    if (window.teacherPerformanceChart instanceof Chart) { window.teacherPerformanceChart.destroy(); }
                                    const perfLabels = response.data.performance_by_grade.map(item => item.asignatura_name);
                                    const perfData = response.data.performance_by_grade.map(item => item.tasa_aprobacion);
                                    window.teacherPerformanceChart = new Chart(ctxPerf, {
                                        type: 'bar',
                                        data: {
                                            labels: perfLabels,
                                            datasets: [{ label: 'Tasa de Aprobación (%)', data: perfData, backgroundColor: 'rgba(75, 192, 192, 0.5)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }]
                                        },
                                        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 } } }
                                    });
                                } else {
                                    if (window.teacherPerformanceChart instanceof Chart) { window.teacherPerformanceChart.destroy(); }
                                    Toast.fire({ icon: 'info', title: 'No hay datos de rendimiento para el gráfico.' });
                                }
                            } else { Toast.fire({ icon: 'error', title: response.message || 'Error al cargar indicadores.' }); }
                        },
                        error: function() { Toast.fire({ icon: 'error', title: 'Error de comunicación al cargar indicadores.' }); }
                    });
                }

                $('#selectAnnLectivo').on('change', function() { loadTeacherGradesAndSections($(this).val()); });
                $('#btnLoadIndicators').on('click', function() { loadTeacherDashboardData(); });
                loadAcademicYearsForTeacher();
            });
        </script>
    {% else %}
        {# Script para el dashboard general con correcciones #}
        <script>
            $(function () {
                let generalMatriculaChart;
                $('#lstannlectivo').select2({ placeholder: "Seleccione un Año", allowClear: true });

                function loadAcademicYearsForGeneralProfiles() {
                    $.ajax({
                        url: 'php_libs/soporte/dashboard/phpAjaxDashboard.inc.php', type: 'POST', dataType: 'json',
                        data: { action: 'getAcademicYears', codigo_perfil: '{{ codigo_perfil }}' },
                        success: function(response) {
                            const $select = $('#lstannlectivo');
                            $select.empty().append('<option value="">Seleccione un Año</option>');
                            if (response.success && response.years.length > 0) {
                                response.years.forEach(function(year) { $select.append(`<option value="${year.codigo}">${year.nombre}</option>`); });
                                // --- AJUSTE PARA CARGA INICIAL ROBUSTA ---
                                // 1. Se establece el valor en el select
                                $select.val(response.years[0].codigo);
                                // 2. Se notifica a select2 que actualice su vista
                                $select.trigger('change.select2');
                                // 3. Se llama directamente a la función de carga de datos
                                loadGeneralDashboardData();
                            } else { Toast.fire({ icon: 'warning', title: response.message || 'No se encontraron años lectivos.' }); }
                        },
                        error: function() { Toast.fire({ icon: 'error', title: 'Error al cargar años lectivos.' }); }
                    });
                }
                
               function loadGeneralDashboardData() { 
                    const selectedAnnLectivo = $('#lstannlectivo').val();
                    if (!selectedAnnLectivo) { return; }
                    $.ajax({
                        url: 'php_libs/soporte/dashboard/phpAjaxDashboard.inc.php', type: 'POST', dataType: 'json',
                        data: { action: 'getGeneralIndicators', codigo_ann_lectivo: selectedAnnLectivo },
                        success: function(response) {
                            if (response.success) {
                             // --- Actualización de Enlaces Dinámicos en el Dropdown ---
                                // 1. Enlace para Reporte de Indicadores
                                const urlReporteIndicadores = `php_libs/reportes/Estadisticos/IndicadoresEducativos.php?ann_lectivo=${selectedAnnLectivo}`;
                                $('#linkReporteIndicadores').attr('href', urlReporteIndicadores);

                                // 2. Enlace para Reporte de Memoria
                                const urlReporteMemoria = `php_libs/reportes/Estadisticos/Memoria.php?ann_lectivo=${selectedAnnLectivo}`;
                                $('#linkReporteMemoria').attr('href', urlReporteMemoria);
                                // --- Fin de la Actualización de Enlaces ---

                                // --- Actualización de los contadores en los small-box ---
                                $('#totalEstudiantesMasculino').text(response.data.total_estudiantes_masculino || 0);
                                $('#totalEstudiantesFemenino').text(response.data.total_estudiantes_femenino || 0);
                                $('#totalEstudiantes').text(response.data.total_estudiantes || 0);
                                
                                $('#totalAdminMasculino').text(response.data.total_admin_masculino || 0);
                                $('#totalAdminFemenino').text(response.data.total_admin_femenino || 0);
                                $('#totalAdminTotal').text(response.data.total_admin_total || 0);
                                
                                $('#totalDocentesMasculino').text(response.data.total_docentes_masculino || 0);
                                $('#totalDocentesFemenino').text(response.data.total_docentes_femenino || 0);
                                $('#totalDocentes').text(response.data.total_docentes || 0);

                                $('#TotalFamilias').text(response.data.total_familias || 0);
                                // ...etc...
                                $('#MatriculaMasculino').text(response.data.total_estudiantes_masculino || 0);
                                $('#MatriculaFemenino').text(response.data.total_estudiantes_femenino || 0);
                                $('#MatriculaTotal').text(response.data.total_estudiantes || 0);
                                if (response.data.matricula_grafico) {
                                    const ctx = document.getElementById('GraficoMatricula').getContext('2d');
                                    if (window.generalMatriculaChart instanceof Chart) { window.generalMatriculaChart.destroy(); }
                                    window.generalMatriculaChart = new Chart(ctx, {
                                        type: 'doughnut',
                                        data: {
                                            labels: ['Masculino', 'Femenino'],
                                            datasets: [{ data: [response.data.matricula_grafico.masculino || 0, response.data.matricula_grafico.femenino || 0], backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'], borderWidth: 1 }]
                                        },
                                        options: { responsive: true, maintainAspectRatio: false }
                                    });
                                }
                                // --- FIN DE LA PARTE SIN CAMBIOS ---


                                // === INICIO DE LA LÓGICA MODIFICADA PARA LA TABLA ===
                                if (response.data.lista_matricula && response.data.lista_matricula.length > 0) {
                                    const $listaMatricula = $('#listaMatricula');
                                    $listaMatricula.empty();
                                    
                                    // 1. Contadores para los totales generales
                                    let grandTotalMasculino = 0, grandTotalFemenino = 0, grandTotalGeneral = 0;
                                    
                                    // 2. Lógica de ordenamiento (sin cambios)
                                    const turnoSortOrder = {"Matutino": 1,"Vespertino": 2,"Jornada Completa": 3,"Nocturna": 4};
                                    response.data.lista_matricula.sort((a, b) => {
                                        const orderA = turnoSortOrder[a.turno.trim()] || 99, orderB = turnoSortOrder[b.turno.trim()] || 99;
                                        if (orderA !== orderB) {return orderA - orderB;}
                                        return a.modalidad.localeCompare(b.modalidad);
                                    });
                                    
                                    // 3. Variables para manejar el subtotal por grupo (turno)
                                    let currentTurno = "";
                                    let subtotalMasculino = 0, subtotalFemenino = 0, subtotalTurno = 0;

                                    response.data.lista_matricula.forEach(function(item, index) {
                                        // 4. Si el turno del item actual es diferente al del grupo que venimos procesando...
                                        // ...y no es la primera fila, significa que un grupo terminó.
                                        if (item.turno.trim() !== currentTurno && currentTurno !== "") {
                                            // Se imprime la fila de subtotales del grupo que acaba de terminar.
                                            $listaMatricula.append(`<tr class="table-info font-weight-bold"><td colspan="3" class="text-right">Subtotal Turno ${currentTurno}</td><td>${subtotalMasculino}</td><td>${subtotalFemenino}</td><td>${subtotalTurno}</td></tr>`);
                                            // Se reinician los contadores para el nuevo grupo.
                                            subtotalMasculino = 0; subtotalFemenino = 0; subtotalTurno = 0;
                                        }

                                        // Se actualiza el turno actual que estamos procesando.
                                        currentTurno = item.turno.trim();
                                        
                                        // Se imprime la fila de datos normal.
                                        $listaMatricula.append(`<tr><td>${index + 1}</td><td>${item.modalidad}</td><td>${item.turno}</td><td>${item.masculino}</td><td>${item.femenino}</td><td>${item.total}</td></tr>`);
                                        
                                        // Se incrementan los contadores de subtotal y total general.
                                        subtotalMasculino += parseInt(item.masculino, 10);
                                        subtotalFemenino += parseInt(item.femenino, 10);
                                        subtotalTurno += parseInt(item.total, 10);
                                        grandTotalMasculino += parseInt(item.masculino, 10);
                                        grandTotalFemenino += parseInt(item.femenino, 10);
                                        grandTotalGeneral += parseInt(item.total, 10);
                                    });

                                    // 5. Al terminar el bucle, el último grupo no ha impreso su subtotal. Lo hacemos aquí.
                                    if (currentTurno !== "") {
                                        $listaMatricula.append(`<tr class="table-info font-weight-bold"><td colspan="3" class="text-right">Subtotal Turno ${currentTurno}</td><td>${subtotalMasculino}</td><td>${subtotalFemenino}</td><td>${subtotalTurno}</td></tr>`);
                                    }

                                    // 6. Finalmente, se imprime la fila de totales generales.
                                    $listaMatricula.append(`<tr class="table-dark font-weight-bolder"><td colspan="3" class="text-right">TOTALES GENERALES</td><td>${grandTotalMasculino}</td><td>${grandTotalFemenino}</td><td>${grandTotalGeneral}</td></tr>`);
                                }
                                // === FIN DE LA LÓGICA MODIFICADA ===
 // === INICIO DE LA NUEVA LÓGICA PARA EL GRÁFICO DE BARRAS ===
                                if (response.data.lista_matricula && response.data.lista_matricula.length > 0) {
                                    // 1. Agrupar y sumar los datos por turno
                                    const turnosData = {};
                                    response.data.lista_matricula.forEach(item => {
                                        const turno = item.turno.trim();
                                        if (!turnosData[turno]) {
                                            turnosData[turno] = { masculino: 0, femenino: 0 };
                                        }
                                        turnosData[turno].masculino += parseInt(item.masculino, 10);
                                        turnosData[turno].femenino += parseInt(item.femenino, 10);
                                    });

                                    // 2. Preparar los arreglos para el gráfico, respetando el orden
                                    const turnoSortOrder = ["Matutino", "Vespertino", "Jornada Completa", "Nocturna"];
                                    const labels = [], dataMasculino = [], dataFemenino = [];

                                    turnoSortOrder.forEach(turno => {
                                        if (turnosData[turno]) {
                                            labels.push(turno);
                                            dataMasculino.push(turnosData[turno].masculino);
                                            dataFemenino.push(turnosData[turno].femenino);
                                        }
                                    });
                                    
                                    // 3. Dibujar el gráfico de barras agrupado
                                    const ctxTurno = document.getElementById('turnoDistributionChart').getContext('2d');
                                    if (window.turnoChart instanceof Chart) { window.turnoChart.destroy(); }

                                    window.turnoChart = new Chart(ctxTurno, {
                                        type: 'bar',
                                        data: {
                                            labels: labels,
                                            datasets: [
                                                {
                                                    label: 'Masculino',
                                                    data: dataMasculino,
                                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                                    borderColor: 'rgba(54, 162, 235, 1)',
                                                    borderWidth: 1
                                                },
                                                {
                                                    label: 'Femenino',
                                                    data: dataFemenino,
                                                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                                    borderColor: 'rgba(255, 99, 132, 1)',
                                                    borderWidth: 1
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            scales: { y: { beginAtZero: true } }
                                        }
                                    });
                                }
                                // === FIN DE LA NUEVA LÓGICA ===
                                $('#GraficosTablas').slideDown('slow');
                            } else { Toast.fire({ icon: 'error', title: response.message || 'Error desconocido.' }); }
                        },
                        error: function() { Toast.fire({ icon: 'error', title: 'Error de comunicación.' }); }
                    });
                }

                // El listener ahora sirve principalmente para cambios manuales del usuario
                $('#lstannlectivo').on('change', function() { loadGeneralDashboardData(); });
                $('#btnLoadGeneralIndicators').on('click', function() { loadGeneralDashboardData(); });
                
                // Inicia todo el proceso
                loadAcademicYearsForGeneralProfiles();
            });
        </script>
    {% endif %}

{% endblock %}